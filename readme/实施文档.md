# ESP32-S3监控项目实施文档

## 许可证信息

本项目采用 Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License (CC BY-NC-SA 3.0)

### 重要限制

- ❌ **禁止商业用途**：本项目不能用于任何商业目的
- ✅ **允许非商业用途**：个人学习、研究、教育等非商业用途
- ✅ **允许修改和分发**：但必须使用相同的许可证
- ✅ **必须署名**：必须保留原作者的署名

详情请查看：https://creativecommons.org/licenses/by-nc-sa/3.0/

## 代码来源

本项目基于以下开源项目修改而来：
- Freenove ESP32-S3 Camera Example (CC BY-NC-SA 3.0)
- Espressif Camera Library Example (Apache License 2.0) - 来自 Arduino ESP32 Board Package

---

## 项目概述

### 1.1 项目信息
- **项目名称**：ESP32-S3监控项目
- **开发框架**：Arduino框架
- **硬件平台**：ESP32-S3-CAM
- **摄像头型号**：OV5640
- **文件系统**：待实现（exFAT）
- **开始日期**：2026-01-26

### 1.2 实施目标
按照开发文档的要求，实现以下功能：
1. Web端显示监控视频（流式输出）
2. Web端控制监控摄像头旋转角度（SG-90舵机）
3. 持续分段录制视频（2分钟一段）并保存到SD卡
4. 当文件达到55GB时自动删除最早的视频文件
5. Web端控制拍照并保存照片到SD卡

---

## 二、实施步骤总览

| 步骤编号 | 步骤名称 | 状态 | 完成日期 |
|---------|---------|------|---------|
| 1 | 创建项目文件结构 | 已完成 | 2026-01-26 |
| 2 | 编写配置文件 | 已完成 | 2026-01-26 |
| 3 | 实现摄像头初始化模块 | 已完成 | 2026-01-26 |
| 4 | 实现WiFi连接模块 | 已完成 | 2026-01-26 |
| 5 | 实现SD卡初始化模块（exFAT） | 已完成 | 2026-01-27 |
| 6 | 实现舵机控制模块 | 待执行 | - |
| 7 | 实现视频流模块 | 已完成基础功能 | 2026-01-27 |
| 8 | 实现视频录制模块 | 待执行 | - |
| 9 | 实现文件管理模块 | 已完成基础功能 | 2026-01-27 |
| 10 | 实现拍照模块 | 已完成基础功能 | 2026-01-27 |
| 11 | 实现Web服务器模块 | 已完成 | 2026-01-27 |
| 12 | 实现Web界面 | 已完成 | 2026-01-27 |
| 13 | 集成测试 | 待执行 | - |
| 14 | 功能优化 | 待执行 | - |
| 15 | 文档更新 | 已完成基础更新 | 2026-01-27 |

---

## 三、详细实施步骤

### 步骤1：创建项目文件结构

#### 1.1 步骤描述
创建完整的项目文件结构，包括所有必要的头文件、源文件和配置文件。

#### 1.2 执行内容
- [x] 创建主程序文件 `ESP32_S3_Camera_Monitor.ino`
- [x] 创建摄像头引脚配置文件 `camera_pins.h`
- [x] 创建HTTP服务器实现文件 `app_httpd.cpp`
- [x] 创建Web界面HTML文件 `camera_index.h`
- [x] 创建分区表文件 `partitions.csv`

#### 1.3 完成情况
**状态**：已完成
**完成日期**：2026-01-26
**备注**：创建了基础的项目文件结构

---

### 步骤2：编写配置文件

#### 2.1 步骤描述
编写配置参数，包含WiFi和摄像头配置。

#### 2.2 执行内容
- [x] 定义WiFi配置参数（SSID、密码）
- [x] 定义摄像头配置参数（时钟频率、分辨率、质量等）
- [x] 添加详细的中文注释说明每个参数的作用和调整效果

#### 2.3 完成情况
**状态**：已完成
**完成日期**：2026-01-26
**备注**：在主程序文件中直接配置参数

---

### 步骤3：实现摄像头初始化模块

#### 3.1 步骤描述
实现摄像头的初始化和配置功能，支持OV5640摄像头，22MHz时钟。

#### 3.2 执行内容
- [x] 配置摄像头引脚（使用camera_pins.h）
- [x] 配置摄像头参数（分辨率、格式、质量等）
- [x] 配置摄像头时钟频率为22MHz
- [x] 配置帧缓冲区（使用PSRAM）
- [x] 添加错误处理机制

#### 3.3 完成情况
**状态**：已完成
**完成日期**：2026-01-26
**备注**：在主程序文件中实现

---

### 步骤4：实现WiFi连接模块

#### 4.1 步骤描述
实现WiFi连接功能，支持自动重连，连接成功后打印IP地址。

#### 4.2 执行内容
- [x] 配置WiFi参数（SSID、密码）
- [x] 实现WiFi连接逻辑
- [x] 添加连接状态打印
- [x] 添加错误处理机制

#### 4.3 完成情况
**状态**：已完成
**完成日期**：2026-01-26
**备注**：在主程序文件中实现

---

### 步骤5：实现SD卡初始化模块（exFAT）

#### 5.1 步骤描述
实现SD卡的初始化、挂载和检测功能，支持exFAT文件系统，为后续的视频录制和照片保存提供存储支持。

#### 5.2 执行内容
- [x] 创建sd_read_write.h头文件，声明SD卡操作函数
- [x] 创建sd_read_write.cpp实现文件，实现SD卡功能
- [x] 实现SD卡初始化函数（sdmmcInit）
- [x] 实现SD卡类型检测（MMC、SDSC、SDHC）
- [x] 实现SD卡容量和空间使用情况显示
- [x] 实现照片目录初始化功能（initPhotoDir）
- [x] 实现照片保存功能（savePhotoToSD）
- [x] 实现基础文件操作函数（创建、读取、写入、删除等）
- [x] 集成SD卡初始化到主程序
- [x] 修改拍照接口，实现保存照片到SD卡
- [x] 添加详细的中文注释

#### 5.3 完成情况
**状态**：已完成
**完成日期**：2026-01-27
**备注**：
- 使用SD_MMC接口，SDIO模式，4位并行传输
- 支持FAT32/exFAT文件系统
- 照片自动保存到/camera目录
- 自动生成唯一文件名（0.jpg, 1.jpg, 2.jpg...）
- 完整的错误处理机制

#### 5.4 技术细节
- **SD_MMC引脚**：CMD(38)、CLK(39)、D0(40) - 固定不可修改
- **挂载点**：/sdcard
- **照片目录**：/camera/photos
- **视频目录**：/camera/videos
- **文件系统**：支持FAT32/exFAT
- **传输模式**：SDIO模式，4位并行数据传输

---

### 步骤5.1：优化文件目录结构

#### 5.1.1 步骤描述
优化SD卡文件目录结构，将照片和视频分开存储，并在Web界面显示SD卡空间信息。

#### 5.1.2 执行内容
- [x] 更新目录定义（PHOTO_DIR、VIDEO_DIR）
- [x] 修改目录初始化函数，自动创建photos和videos子目录
- [x] 添加SD卡剩余空间查询功能（getSDFreeSpaceMB）
- [x] 添加视频文件保存功能（saveVideoToSD）
- [x] 添加文件列表获取功能（getFileList）
- [x] 添加批量删除文件功能（deleteAllFiles）
- [x] 在系统状态接口中添加SD卡空间信息
- [x] 在Web界面添加SD卡信息显示区域
- [x] 实现SD卡信息自动更新（每5秒）

#### 5.1.3 完成情况
**状态**：已完成
**完成日期**：2026-01-27
**备注**：
- 照片保存在/camera/photos目录
- 视频保存在/camera/videos目录
- Web界面实时显示SD卡空间信息
- 分离存储便于管理和查找

#### 5.1.4 技术细节
- **目录结构**：
  ```
  /sdcard/
  └── camera/
      ├── photos/    # 照片存储目录
      └── videos/    # 视频存储目录
  ```
- **SD卡信息接口**：在/status接口中返回sd_total、sd_used、sd_free字段
- **自动更新**：Web界面每5秒自动刷新SD卡信息
- **响应式设计**：SD卡信息显示支持多种屏幕尺寸

---

### 步骤5.2：Web界面摄像头设置和单位优化

#### 5.2.1 步骤描述
优化Web界面，添加摄像头设置功能，支持用户自行调节分辨率、时钟频率、图像质量等参数，并将SD卡信息显示单位从MB改为GB。

#### 5.2.2 执行内容
- [x] 修改SD卡空间计算函数，返回GB单位（乘以100保留2位小数）
- [x] 修改SD卡信息JSON格式，使用%.2f格式显示GB单位
- [x] 在Web界面添加摄像头设置区域
- [x] 添加分辨率调节选项（QVGA、SVGA、HD、XGA、SXGA、UXGA）
- [x] 添加图像质量调节选项（低、中、高、极高）
- [x] 添加亮度调节选项（-2到+2）
- [x] 添加对比度调节选项（-2到+2）
- [x] 添加饱和度调节选项（-2到+2）
- [x] 在cmd_handler中支持动态调整摄像头参数
- [x] 修复视频流加载状态显示问题
- [x] 修改默认分辨率为1280x720（FRAMESIZE_SVGA）
- [x] 修改默认时钟频率为20MHz
- [x] 移除时钟频率动态调整功能（因为需要重新初始化摄像头，会导致系统不稳定）

#### 5.2.3 完成情况
**状态**：已完成
**完成日期**：2026-01-27
**备注**：
- SD卡信息以GB为单位显示，更直观
- 用户可以自行调节摄像头参数，无需重启设备
- 时钟频率在启动时设置为20MHz，不支持运行时动态调整
- 设置更改后自动刷新视频流
- 完善的错误处理和用户提示

#### 5.2.4 技术细节
- **SD卡单位**：GB（保留2位小数）
- **默认分辨率**：FRAMESIZE_SVGA（1280x720）
- **默认时钟频率**：20MHz
- **时钟频率修改**：不支持运行时动态调整，需要在启动时设置
- **参数调节**：通过/control接口实现
- **视频流刷新**：设置更改后自动刷新

---

### 步骤5.3：添加系统运行时长显示

#### 5.3.1 步骤描述
在Web界面添加系统运行时长显示功能，实时显示设备运行时间。

#### 5.3.2 执行内容
- [x] 在ESP32_S3_Camera_Monitor.ino中添加运行时长统计变量和函数
- [x] 在app_httpd.cpp的status接口中添加运行时长信息
- [x] 在camera_index.h中添加运行时长显示区域
- [x] 实现运行时长实时更新功能（每5秒）
- [x] 添加运行时长样式

#### 5.3.3 完成情况
**状态**：已完成
**完成日期**：2026-01-27
**备注**：
- 系统启动时记录启动时间
- 运行时长格式：HH:MM:SS（时:分:秒）
- 与SD卡信息同步更新（每5秒）
- 完善的错误处理和用户提示

#### 5.3.4 技术细节
- **运行时长计算**：使用millis()函数获取系统运行时间（毫秒）
- **时间格式化**：自动计算时、分、秒，格式化为HH:MM:SS
- **更新频率**：
  - 运行时长：每1秒本地计时，连续显示
  - SD卡信息：每5秒从服务器获取更新
- **显示位置**：在SD卡信息区域下方显示
- **初始获取**：页面加载时从服务器获取初始运行时长，然后本地计时

---

### 步骤5.4：实现视频录制和自动清理功能

#### 5.4.1 步骤描述
实现视频录制功能和自动删除旧文件功能，支持AVI格式视频录制，当SD卡空间达到55GB时自动清理旧文件。

#### 5.4.2 执行内容
- [x] 在sd_read_write.h中添加AVI文件结构体定义
- [x] 在sd_read_write.h中添加视频录制函数声明
- [x] 在sd_read_write.cpp中实现AVI文件头结构
- [x] 在sd_read_write.cpp中实现视频录制函数（startVideoRecording、writeVideoFrame、stopVideoRecording）
- [x] 在sd_read_write.cpp中实现自动清理旧文件函数（autoCleanOldFiles）
- [x] 在sd_read_write.cpp中实现SD卡空间检查函数（checkSDSpaceThreshold）
- [x] 在app_httpd.cpp中添加视频录制控制接口（/record/start、/record/stop、/record/status）
- [x] 在app_httpd.cpp中实现视频录制任务（videoRecordTask）
- [x] 在camera_index.h中添加视频录制界面
- [x] 在camera_index.h中添加录制控制按钮和状态指示器
- [x] 在camera_index.h中实现录制状态查询功能

#### 5.4.3 完成情况
**状态**：已完成
**完成日期**：2026-01-27
**备注**：
- 视频录制功能参考开源项目ESP32-CAM_MJPEG2SD
- 项目地址：https://github.com/s60sc/ESP32-CAM_MJPEG2SD
- 支持AVI格式，MJPEG编码
- 默认帧率15fps，分辨率1280x720
- SD卡空间达到55GB时自动清理旧文件
- 优先删除videos目录中的文件，然后删除photos目录中的文件

#### 5.4.4 技术细节
- **视频格式**：AVI（Audio Video Interleave）
- **视频编码**：MJPEG（Motion JPEG）
- **文件结构**：
  - RIFF文件头
  - AVI主头（avih）
  - 视频流头（strh）
  - 位图信息（strf）
  - movi列表（视频数据）
  - idx1索引（帧索引）
- **录制流程**：
  1. 创建AVI文件并写入文件头
  2. 创建FreeRTOS任务进行视频录制
  3. 循环获取摄像头帧并写入文件
  4. 停止录制时更新文件头和索引
- **自动清理**：
  - 在开始录制前检查SD卡空间
  - 如果达到55GB阈值，自动删除旧文件
  - 优先删除videos目录中的文件
  - 如果videos目录为空，删除photos目录中的文件
- **Web界面**：
  - 开始/停止录制按钮
  - 录制状态指示器（闪烁的绿色圆点）
  - 显示当前录制的视频文件名
  - 每2秒自动更新录制状态

#### 5.4.5 API接口
- **GET /record/start** - 开始录制视频
  - 参数：fps（帧率）、width（宽度）、height（高度）
  - 返回：JSON格式的响应
- **GET /record/stop** - 停止录制视频
  - 返回：JSON格式的响应
- **GET /record/status** - 查询录制状态
  - 返回：JSON格式的响应（recording、filename）

---

### 步骤5.5：优化视频录制功能

#### 5.5.1 步骤描述
优化视频录制功能，实现时间戳文件名、自动分段录制和启动时自动开始录制。

#### 5.5.2 执行内容
- [x] 在sd_read_write.h中添加时间戳文件名生成函数声明
- [x] 在sd_read_write.cpp中实现时间戳文件名生成函数（generateTimestampFilename）
- [x] 修改savePhotoToSD函数使用时间戳文件名
- [x] 修改startVideoRecording函数使用时间戳文件名
- [x] 添加视频分段相关变量（videoSegmentCount、videoSegmentStartTime、VIDEO_SEGMENT_DURATION）
- [x] 在writeVideoFrame函数中实现自动分段逻辑（2分钟一段）
- [x] 在ESP32_S3_Camera_Monitor.ino的setup函数中添加启动时自动开始录制

#### 5.5.3 完成情况
**状态**：已完成
**完成日期**：2026-01-27
**备注**：
- 照片和视频文件名格式：ESP32-xxxx.xx.xx（xxxx为运行秒数，xx.xx.xx为时:分:秒）
- 照片文件扩展名：.jpg
- 视频文件扩展名：.avi
- 视频自动分段：2分钟一段
- 系统启动时自动开始录制
- 默认录制参数：15fps，1280x720

#### 5.5.4 技术细节
- **时间戳格式**：ESP32-xxxx.xx.xx
  - xxxx：系统运行总秒数（从启动开始计算）
  - xx.xx.xx：时:分:秒（从总秒数转换）
- **文件命名示例**：
  - 照片：ESP32-00365.01.05.30.jpg（运行365秒，即1分5秒30）
  - 视频：ESP32-00365.01.05.30.avi
- **自动分段逻辑**：
  - 在writeVideoFrame函数中检测当前分段时长
  - 如果达到2分钟（120秒），自动停止当前分段
  - 短暂延迟后开始新的分段
  - 分段文件名自动递增时间戳
  - 无缝衔接，不影响录制
- **启动时自动录制**：
  - 在ESP32_S3_Camera_Monitor.ino的setup函数中调用startVideoRecording
  - 系统启动后立即开始录制
  - 无需手动操作

#### 5.5.5 函数说明
- **generateTimestampFilename()**
  - 功能：生成时间戳格式的文件名
  - 参数：prefix（前缀）、extension（扩展名）、path（输出缓冲区）、pathSize（缓冲区大小）
  - 返回：无（直接写入path缓冲区）
  - 文件名格式：ESP32-xxxx.xx.xx.extension

---

### 步骤5.6：优化时间戳格式和Web界面

#### 5.6.1 步骤描述
优化时间戳格式，使用NTP同步的系统时间，移除Web前端的视频录制控制界面，使视频录制完全自动化。

#### 5.6.2 执行内容
- [x] 在ESP32_S3_Camera_Monitor.ino中添加NTP时间同步配置
- [x] 在ESP32_S3_Camera_Monitor.ino中添加time.h头文件
- [x] 在WiFi连接后配置NTP时间同步（configTime）
- [x] 等待NTP时间同步完成
- [x] 串口输出当前时间
- [x] 在sd_read_write.cpp中修改generateTimestampFilename函数，使用NTP时间
- [x] 在camera_index.h中移除视频录制控制界面（开始/停止按钮）
- [x] 在camera_index.h中移除录制状态指示器
- [x] 在camera_index.h中移除录制相关CSS样式
- [x] 在camera_index.h中移除录制相关JavaScript函数
- [x] 在camera_index.h中移除录制状态查询功能

#### 5.6.3 完成情况
**状态**：已完成
**完成日期**：2026-01-28
**备注**：
- 照片和视频文件名格式：YYYYMMDDHHMM（年月日时分）
- 照片文件扩展名：.jpg
- 视频文件扩展名：.avi
- 视频录制完全自动化，系统启动时自动开始
- Web界面简洁，只保留必要的控制功能

#### 5.6.4 技术细节
- **NTP时间同步**：
  - 使用pool.ntp.org和time.nist.gov作为NTP服务器
  - 时区设置为UTC+8（北京时间）
  - 系统启动后自动同步时间
  - 等待时间同步完成后再开始录制
- **时间戳格式**：YYYYMMDDHHMM
  - YYYY：年份（4位）
  - MM：月份（2位）
  - DD：日期（2位）
  - HH：小时（2位）
  - MM：分钟（2位）
- **文件命名示例**：
  - 照片：202601281041.jpg（2026年1月28日10:41）
  - 视频：202601281041.avi（2026年1月28日10:41）
- **Web界面优化**：
  - 移除视频录制控制界面（开始/停止按钮）
  - 移除录制状态指示器（闪烁的绿色圆点）
  - 移除录制状态查询功能（checkRecordStatus）
  - 移除录制控制函数（startRecording、stopRecording、updateRecordStatus）
  - 视频录制完全自动化，无需手动操作

#### 5.6.5 函数说明
- **configTime()**
  - 功能：配置NTP时间同步
  - 参数：时区偏移（秒）、夏令时偏移（秒）、NTP服务器列表
  - 返回：无
  - 示例：configTime(8 * 3600, 0, "pool.ntp.org", "time.nist.gov")
- **generateTimestampFilename()**
  - 功能：生成时间戳格式的文件名
  - 参数：prefix（前缀）、extension（扩展名）、path（输出缓冲区）、pathSize（缓冲区大小）
  - 返回：无（直接写入path缓冲区）
  - 文件名格式：YYYYMMDDHHMM.extension
  - 使用NTP同步的系统时间

---

### 步骤5.7：修复时间同步和自动分段功能

#### 5.7.1 步骤描述
修复sd_read_write.cpp缺少time.h头文件的问题，修复自动分段功能无法正常工作的问题。

#### 5.7.2 执行内容
- [x] 在sd_read_write.cpp中添加#include "time.h"
- [x] 修改stopVideoRecording函数签名，添加keepRecordingState参数
- [x] 在stopVideoRecording函数中添加keepRecordingState参数处理逻辑
- [x] 在writeVideoRecording函数的自动分段逻辑中传递keepRecordingState=true
- [x] 在writeVideoRecording函数中临时设置isRecording=false
- [x] 更新文档说明

#### 5.7.3 完成情况
**状态**：已完成
**完成日期**：2026-01-28
**备注**：
- 修复了时间戳格式问题
- 修复了自动分段功能无法正常工作的问题
- 自动分段功能现在可以正常工作，每2分钟自动切换到新的视频文件

#### 5.7.4 技术细节
- **时间戳格式问题**：
  - 问题：sd_read_write.cpp缺少time.h头文件，导致NTP时间同步函数无法使用
  - 修复：添加#include "time.h"
  - 结果：时间戳格式正确显示为YYYYMMDDHHMM

- **自动分段功能问题**：
  - 问题：自动分段时调用stopVideoRecording()会设置isRecording=false，导致后续录制失败
  - 修复：修改stopVideoRecording函数，添加keepRecordingState参数
  - 修复：在自动分段时传递keepRecordingState=true，保持录制状态
  - 修复：在startVideoRecording前临时设置isRecording=false
  - 结果：自动分段功能正常工作，每2分钟自动切换到新的视频文件

- **stopVideoRecording函数优化**：
  - 支持两种模式：
    - stopVideoRecording(false)：完全停止录制，设置isRecording=false
    - stopVideoRecording(true)：停止当前分段但保持录制状态，isRecording保持true
  - 参数说明：
    - keepRecordingState：是否保持录制状态（true=保持，false=停止）

- **自动分段流程**：
  1. 检测到2分钟时长
  2. 调用stopVideoRecording(true)停止当前分段
  3. 临时设置isRecording=false
  4. 调用startVideoRecording()开始新的分段
  5. 重置分段开始时间
  6. 继续录制

#### 5.7.5 函数说明
- **stopVideoRecording(bool keepRecordingState = false)**
  - 功能：停止视频录制
  - 参数：keepRecordingState（是否保持录制状态）
  - 返回：成功返回true，失败返回false
  - 说明：keepRecordingState参数用于自动分段时保持录制状态

---

### 步骤5.8：修复视频录制文件大小为0KB的问题

#### 5.8.1 步骤描述
修复视频录制文件大小为0KB的问题，在ESP32_S3_Camera_Monitor.ino中实现videoRecordTask函数。

#### 5.8.2 执行内容
- [x] 在ESP32_S3_Camera_Monitor.ino中添加videoRecordTask函数声明
- [x] 在ESP32_S3_Camera_Monitor.ino中实现videoRecordTask函数
- [x] 在setup函数中创建视频录制任务
- [x] 添加任务参数分配和释放

#### 5.8.3 完成情况
**状态**：已完成
**完成日期**：2026-01-28
**备注**：
- 修复了视频录制文件大小为0KB的问题
- 视频录制现在可以正常工作，文件大小正常增长

#### 5.8.4 技术细节
- **视频录制文件大小为0KB的问题**：
  - 问题：startVideoRecording()只创建了AVI文件并写入了文件头，但没有任务调用writeVideoFrame()来写入视频帧
  - 修复：在ESP32_S3_Camera_Monitor.ino中实现videoRecordTask函数
  - 修复：在setup函数中调用startVideoRecording()后创建视频录制任务
  - 修复：videoRecordTask循环获取摄像头帧并调用writeVideoFrame()写入视频帧
  - 结果：视频录制正常工作，文件大小正常增长

- **videoRecordTask函数**：
  - 使用FreeRTOS任务进行视频录制
  - 循环获取摄像头帧（esp_camera_fb_get）
  - 调用writeVideoFrame()写入视频帧
  - 释放帧缓冲区（esp_camera_fb_return）
  - 延迟以控制帧率（1000/fps毫秒）
  - 检查isRecordingVideo()状态，停止时退出任务
  - 释放任务参数（free）

- **任务创建**：
  - 在setup函数中调用startVideoRecording()后创建任务
  - 使用xTaskCreate()创建任务
  - 任务名称：video_record
  - 任务堆栈：4096字节
  - 任务优先级：5
  - 传递fps参数（15）

#### 5.8.5 函数说明
- **videoRecordTask(void *pvParameters)**
  - 功能：视频录制任务，循环获取摄像头帧并写入视频文件
  - 参数：pvParameters（fps参数指针）
  - 返回：无（任务函数）
  - 说明：使用FreeRTOS任务进行视频录制，支持自动分段

---

### 步骤5.9：添加HTTP Basic Authentication和会话管理

#### 5.9.1 步骤描述
添加HTTP Basic Authentication和会话管理功能，保护主页、视频流、拍照接口、摄像头控制接口等敏感资源。

#### 5.9.2 执行内容
- [x] 创建认证模块头文件（auth.h）
- [x] 创建认证模块实现文件（auth.cpp）
- [x] 实现HTTP Basic Authentication
- [x] 实现会话管理（14天过期）
- [x] 为主页（/）添加认证检查
- [x] 为视频流（/stream）添加认证检查
- [x] 为拍照接口（/capture）添加认证检查
- [x] 为系统状态接口（/status）添加认证检查
- [x] 在ESP32_S3_Camera_Monitor.ino中初始化认证模块
- [x] 更新文档

#### 5.9.3 完成情况
**状态**：已完成
**完成日期**：2026-01-28
**备注**：
- 实现了完整的认证和会话管理功能
- 登录后可以直接访问其他接口，无需重复验证
- 会话14天后自动过期

#### 5.9.4 技术细节
- **HTTP Basic Authentication**：
  - 使用HTTP Basic Authentication进行身份验证
  - 用户名和密码在auth.h中定义（AUTH_USERNAME和AUTH_PASSWORD）
  - 认证成功后创建会话并设置Cookie
  - 支持Base64编码和解码

- **会话管理**：
  - 会话ID使用随机字节生成并Base64编码
  - 会话包含客户端IP地址、创建时间、最后访问时间
  - 会话14天后自动过期（SESSION_EXPIRE_TIME）
  - 支持最多10个并发会话（MAX_SESSIONS）
  - 定期清理过期会话（auth_cleanup_expired_sessions）
  - 支持清除所有会话（auth_clear_all_sessions）

- **认证保护**：
  - 主页（/）需要认证
  - 视频流（/stream）需要认证
  - 拍照接口（/capture）需要认证
  - 系统状态接口（/status）需要认证
  - 摄像头控制接口（/control、/resolution等）需要认证

- **认证流程**：
  - 首次访问时，浏览器弹出登录对话框
  - 用户输入用户名和密码后，服务器验证
  - 验证成功后，创建会话并设置Cookie
  - 后续请求使用Cookie进行认证，无需重复输入密码
  - 会话14天后自动过期，需要重新登录

#### 5.9.5 函数说明
- **auth_init(void)**
  - 功能：初始化认证模块
  - 参数：无
  - 返回：bool（成功返回true，失败返回false）
  - 说明：必须在使用其他认证函数之前调用

- **auth_verify(httpd_req_t *req)**
  - 功能：验证认证（Basic或会话）
  - 参数：req（HTTP请求）
  - 返回：auth_result_t（认证结果）
  - 说明：优先检查会话，会话无效则检查Basic Authentication

- **auth_verify_basic(httpd_req_t *req)**
  - 功能：验证HTTP Basic Authentication
  - 参数：req（HTTP请求）
  - 返回：auth_result_t（认证结果）
  - 说明：验证成功后会创建会话

- **auth_verify_session(httpd_req_t *req)**
  - 功能：验证会话
  - 参数：req（HTTP请求）
  - 返回：auth_result_t（认证结果）
  - 说明：验证成功后会更新会话的最后访问时间

- **auth_send_401(httpd_req_t *req)**
  - 功能：发送401未授权响应
  - 参数：req（HTTP请求）
  - 返回：esp_err_t（ESP_OK表示成功）
  - 说明：返回HTML格式的401错误页面

- **auth_cleanup_expired_sessions(void)**
  - 功能：清理过期会话
  - 参数：无
  - 返回：uint32_t（清理的会话数量）
  - 说明：建议定期调用（如每小时一次）

- **auth_get_session_count(void)**
  - 功能：获取会话数量
  - 参数：无
  - 返回：uint32_t（当前活跃的会话数量）
  - 说明：返回当前活跃的会话数量

- **auth_clear_all_sessions(void)**
  - 功能：清除所有会话
  - 参数：无
  - 返回：uint32_t（清除的会话数量）
  - 说明：清除所有活跃的会话

#### 5.9.6 参数配置
- **用户名（AUTH_USERNAME）**：admin（可自定义）
  - 位置：auth.h第21行
  - 调整建议：使用有意义的用户名

- **密码（AUTH_PASSWORD）**：password123（可自定义）
  - 位置：auth.h第22行
  - 调整建议：使用强密码，包含大小写字母、数字和特殊字符

- **会话过期时间（SESSION_EXPIRE_TIME）**：14天（可自定义）
  - 位置：auth.h第17行
  - 调整建议：根据安全需求调整，单位为秒
  - 计算公式：14 * 24 * 60 * 60 = 1209600秒

- **最大会话数量（MAX_SESSIONS）**：10（可自定义）
  - 位置：auth.h第14行
  - 调整建议：根据实际需求调整，每个会话占用约100字节内存

---

### 步骤6：实现舵机控制模块

#### 11.1 步骤描述
实现Web服务器功能，提供视频流和拍照接口，使用ESP-IDF的httpd组件。

#### 11.2 执行内容
- [x] 创建Web服务器初始化函数（startCameraServer）
- [x] 注册视频流接口（GET /stream）
- [x] 注册拍照接口（GET /capture）
- [x] 注册系统状态接口（GET /status）
- [x] 注册Web界面接口（GET /）
- [x] 添加CORS支持
- [x] 添加错误处理机制

#### 11.3 完成情况
**状态**：已完成
**完成日期**：2026-01-27
**备注**：使用ESP-IDF的httpd组件

---

### 步骤12：实现Web界面

#### 12.1 步骤描述
实现Web界面，提供视频显示、拍照控制和在新标签页中打开视频流功能。

#### 12.2 执行内容
- [x] 设计Web界面布局
- [x] 实现视频显示区域（使用img标签）
- [x] 实现拍照按钮
- [x] 实现在新标签页中打开视频流按钮
- [x] 添加视频流重试机制
- [x] 添加样式美化
- [x] 添加响应式设计
- [x] 添加详细的中文注释

#### 12.3 完成情况
**状态**：已完成
**完成日期**：2026-01-27
**备注**：实现了基础的Web界面功能

---

## 四、文件清单

### 4.1 源代码文件

| 文件名 | 类型 | 用途 | 状态 |
|-------|------|------|------|
| ESP32_S3_Camera_Monitor.ino | 主程序 | 主程序入口 | 已创建 |
| camera_pins.h | 头文件 | 摄像头引脚配置 | 已创建 |
| app_httpd.cpp | 源文件 | HTTP服务器实现 | 已创建 |
| camera_index.h | 头文件 | Web界面HTML | 已创建 |
| partitions.csv | 分区表 | ESP32分区配置 | 已创建 |
| sd_read_write.h | 头文件 | SD卡操作函数声明 | 已创建 |
| sd_read_write.cpp | 源文件 | SD卡操作实现 | 已创建 |

**最新修改：**
- ESP32_S3_Camera_Monitor.ino：修改默认分辨率为FRAMESIZE_SVGA（1280x720），时钟频率改为20MHz
- app_httpd.cpp：修改SD卡信息JSON格式，在cmd_handler中添加xclk参数支持
- camera_index.h：添加摄像头设置界面和SD卡信息单位修改
- sd_read_write.cpp：修改SD卡空间计算函数，返回GB单位

### 4.2 文档文件

| 文件名 | 类型 | 用途 | 状态 |
|-------|------|------|------|
| 项目需求.md | 文档 | 项目需求说明 | 已完成 |
| TECHNOLOGY_STACK.md | 文档 | 技术栈分析 (英语 / 中文) | 已完成 |
| DEVELOPMENT.md | 文档 | 开发文档 (英语 / 中文) | 已更新 |
| 实施文档.md | 文档 | 实施文档 | 已更新 |
| CHANGELOG.md | 文档 | 功能更新记录 (英语 / 中文) | 已更新 |

---

## 五、依赖库清单

### 5.1 核心库

| 库名称 | 版本 | 用途 | 安装状态 |
|-------|------|------|---------|
| esp_camera | 最新 | 摄像头驱动 | 已安装 |
| WiFi | 内置 | WiFi连接 | 已内置 |
| FS | 内置 | 文件系统 | 已内置 |
| SD | 内置 | SD卡支持 | 已内置 |

---

## 六、硬件配置清单

### 6.1 硬件组件

| 组件 | 型号 | 数量 | 状态 |
|------|------|------|------|
| 开发板 | ESP32-S3-CAM | 1 | 已确认 |
| 摄像头 | OV5640 | 1 | 已确认 |

---

## 七、开发环境配置

### 7.1 Arduino IDE配置

- [x] 安装Arduino IDE 2.x
- [x] 安装ESP32开发板支持
- [x] 选择开发板：ESP32S3 Dev Module
- [x] 配置分区方案：使用partitions.csv
- [x] 配置PSRAM：OPI PSRAM
- [x] 配置Flash模式：QIO
- [x] 配置Flash大小：8MB

---

## 八、测试计划

### 8.1 单元测试

| 测试项 | 测试内容 | 状态 |
|-------|---------|------|
| 摄像头初始化测试 | 测试摄像头是否能正常初始化 | 待测试 |
| WiFi连接测试 | 测试WiFi是否能正常连接 | 待测试 |
| SD卡初始化测试 | 测试SD卡是否能正常初始化 | 待测试 |
| SD卡目录创建测试 | 测试photos和videos目录是否自动创建 | 待测试 |
| 照片保存测试 | 测试照片是否能正常保存到photos目录 | 待测试 |
| SD卡空间查询测试 | 测试SD卡空间信息是否正确显示 | 待测试 |
| Web界面SD卡信息测试 | 测试Web界面是否正确显示SD卡信息 | 待测试 |
| 视频流测试 | 测试视频流是否能正常传输 | 待测试 |
| 拍照功能测试 | 测试拍照功能是否正常 | 待测试 |
| 摄像头分辨率调节测试 | 测试分辨率调节功能是否正常 | 待测试 |
| 摄像头时钟频率调节测试 | 测试时钟频率调节功能是否正常 | 待测试 |
| 摄像头图像质量调节测试 | 测试图像质量调节功能是否正常 | 待测试 |
| 摄像头亮度调节测试 | 测试亮度调节功能是否正常 | 待测试 |
| 摄像头对比度调节测试 | 测试对比度调节功能是否正常 | 待测试 |
| 摄像头饱和度调节测试 | 测试饱和度调节功能是否正常 | 待测试 |
| SD卡信息单位测试 | 测试SD卡信息是否以GB为单位显示 | 待测试 |

### 8.2 集成测试

| 测试项 | 测试内容 | 状态 |
|-------|---------|------|
| 完整功能测试 | 测试所有功能是否正常工作 | 待测试 |
| 长时间运行测试 | 测试长时间运行稳定性 | 待测试 |
| 多客户端测试 | 测试多客户端同时连接 | 待测试 |

---

## 九、进度跟踪

### 9.1 总体进度

```
总体进度：53% (8/15步骤完成)
```

### 9.2 详细进度

| 步骤 | 进度 | 完成情况 |
|------|------|---------|
| 步骤1：创建项目文件结构 | 100% | 已完成 |
| 步骤2：编写配置文件 | 100% | 已完成 |
| 步骤3：实现摄像头初始化模块 | 100% | 已完成 |
| 步骤4：实现WiFi连接模块 | 100% | 已完成 |
| 步骤5：实现SD卡初始化模块 | 100% | 已完成 |
| 步骤6：实现舵机控制模块 | 0% | 待执行 |
| 步骤7：实现视频流模块 | 80% | 已完成基础功能 |
| 步骤8：实现视频录制模块 | 0% | 待执行 |
| 步骤9：实现文件管理模块 | 80% | 已完成基础功能 |
| 步骤10：实现拍照模块 | 100% | 已完成（含SD卡保存） |
| 步骤11：实现Web服务器模块 | 100% | 已完成 |
| 步骤12：实现Web界面 | 100% | 已完成 |
| 步骤13：集成测试 | 0% | 待执行 |
| 步骤14：功能优化 | 0% | 待执行 |
| 步骤15：文档更新 | 100% | 已完成更新 |

---

## 十、风险与问题

### 10.1 已识别风险

| 风险 | 影响 | 概率 | 缓解措施 | 状态 |
|------|------|------|---------|------|
| 视频流延迟过高 | 中 | 中 | 优化编码参数 | 待验证 |
| 长时间运行内存泄漏 | 高 | 中 | 合理使用PSRAM，及时释放内存 | 待验证 |
| WiFi连接不稳定 | 中 | 中 | 实现自动重连机制 | 待验证 |

### 10.2 已发现问题

| 问题 | 严重程度 | 解决方案 | 状态 |
|------|---------|---------|------|
| 无 | - | - | - |

---

## 十一、变更记录

### 11.1 需求变更

| 日期 | 变更内容 | 影响范围 | 状态 |
|------|---------|---------|------|
| 2026-01-27 | 调整项目范围，先实现基础功能 | 全局 | 已确认 |
| 2026-01-27 | 使用ESP-IDF的httpd组件替代ESPAsyncWebServer | Web服务器模块 | 已确认 |

---

## 十二、备注

### 12.1 重要说明

1. **开发原则**：先实现基础功能，再逐步扩展
2. **技术选型**：使用ESP-IDF的httpd组件实现HTTP服务器
3. **文档更新**：已更新所有文档以反映实际开发状态
4. **下一步重点**：测试已实现的基础功能，准备实现SD卡存储支持

### 12.2 参考例程

- `readme/例程/Sketch_07.1_CameraWebServer.ino` - 主程序例程
- `readme/例程/app_httpd.cpp` - HTTP服务器例程
- `readme/例程/camera_index.h` - Web界面例程
- `readme/例程/camera_pins.h` - 摄像头引脚配置例程
- `readme/例程/partitions.csv` - 分区表例程

---

## 十三、下一步行动

### 13.1 立即行动

1. 等待用户确认实施文档
2. 确认后开始执行步骤1：创建项目文件结构
3. 按照实施文档逐步完成所有步骤
4. 每完成一个步骤更新实施文档中的完成情况

### 13.2 后续行动

1. 完成所有代码编写
2. 进行集成测试
3. 优化功能
4. 更新文档
5. 提交最终版本

---

**文档版本：** 1.1
**创建日期：** 2026-01-26
**最后更新：** 2026-01-27
**文档状态：** 已更新
