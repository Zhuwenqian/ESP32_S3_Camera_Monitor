# 功能更新文档

## 许可证信息

本项目采用 Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License (CC BY-NC-SA 3.0)

### 重要限制

- ❌ **禁止商业用途**：本项目不能用于任何商业目的
- ✅ **允许非商业用途**：个人学习、研究、教育等非商业用途
- ✅ **允许修改和分发**：但必须使用相同的许可证
- ✅ **必须署名**：必须保留原作者的署名

详情请查看：https://creativecommons.org/licenses/by-nc-sa/3.0/

## 代码来源

本项目基于以下开源项目修改而来：
- Freenove ESP32-S3 Camera Example (CC BY-NC-SA 3.0)
- Espressif Camera Library Example (Apache License 2.0) - 来自 Arduino ESP32 Board Package

---

## 项目信息
- **项目名称**：ESP32-S3监控项目
- **开始日期**：2026-01-26
- **文档版本**：1.10

## 更新记录

### 2026-01-28 - 添加HTTP Basic Authentication和会话管理
**更新内容：**
- 创建认证模块（auth.h和auth.cpp）
- 实现HTTP Basic Authentication
- 实现会话管理（14天过期）
- 为主页、视频流、拍照接口、摄像头控制接口添加认证保护
- 登录后可以直接访问其他接口，无需重复验证
- 会话14天后自动过期

**修改的文件：**
1. auth.h - 认证模块头文件
2. auth.cpp - 认证模块实现
3. app_httpd.cpp - 为各个接口添加认证检查
4. ESP32_S3_Camera_Monitor.ino - 初始化认证模块

**技术特点：**
- HTTP Basic Authentication：
  - 使用HTTP Basic Authentication进行身份验证
  - 用户名和密码在auth.h中定义（AUTH_USERNAME和AUTH_PASSWORD）
  - 认证成功后创建会话并设置Cookie
  
- 会话管理：
  - 会话ID使用随机字节生成并Base64编码
  - 会话包含客户端IP地址、创建时间、最后访问时间
  - 会话14天后自动过期（SESSION_EXPIRE_TIME）
  - 支持最多10个并发会话（MAX_SESSIONS）
  - 定期清理过期会话（auth_cleanup_expired_sessions）
  
- 认证保护：
  - 主页（/）需要认证
  - 视频流（/stream）需要认证
  - 拍照接口（/capture）需要认证
  - 系统状态接口（/status）需要认证
  - 摄像头控制接口（/control、/resolution等）需要认证
  
- 认证流程：
  - 首次访问时，浏览器弹出登录对话框
  - 用户输入用户名和密码后，服务器验证
  - 验证成功后，创建会话并设置Cookie
  - 后续请求使用Cookie进行认证，无需重复输入密码
  - 会话14天后自动过期，需要重新登录

**用户名和密码位置：**
- 文件：auth.h
- 行号：第21-22行
- 定义：
  ```c
  #define AUTH_USERNAME "admin"
  #define AUTH_PASSWORD "password123"
  ```

**参数调整：**
- 用户名（AUTH_USERNAME）：admin（可自定义）
  - 调整建议：使用有意义的用户名
- 密码（AUTH_PASSWORD）：password123（可自定义）
  - 调整建议：使用强密码，包含大小写字母、数字和特殊字符
- 会话过期时间（SESSION_EXPIRE_TIME）：14天（可自定义）
  - 调整建议：根据安全需求调整，单位为秒
- 最大会话数量（MAX_SESSIONS）：10（可自定义）
  - 调整建议：根据实际需求调整，每个会话占用约100字节内存

**下一步计划：**
- 实现舵机控制功能
- 测试视频录制功能稳定性
- 优化视频质量和文件大小
- 添加视频播放功能

---

### 2026-01-28 - 修复编译错误（videoRecordTask重复定义）
**更新内容：**
- 删除app_httpd.cpp中的videoRecordTask函数定义
- 删除app_httpd.cpp中的视频录制控制接口（/record/start、/record/stop、/record/status）
- 删除app_httpd.cpp中的视频录制控制变量（isVideoRecording、videoRecordTaskHandle）
- 更新app_httpd.cpp文件头说明

**修改的文件：**
1. app_httpd.cpp - 删除videoRecordTask函数和相关接口

**修复的问题：**
1. 编译错误：multiple definition of `videoRecordTask(void*)'
   - 问题：app_httpd.cpp和ESP32_S3_Camera_Monitor.ino中都定义了videoRecordTask函数
   - 修复：删除app_httpd.cpp中的videoRecordTask函数定义
   - 修复：删除app_httpd.cpp中的视频录制控制接口
   - 修复：删除app_httpd.cpp中的视频录制控制变量
   - 结果：编译成功，不再有重复定义错误

**技术特点：**
- 视频录制完全自动化：
  - 系统启动时自动开始录制
  - 不再需要Web界面的录制控制
  - 不再需要HTTP接口控制录制
  
- 代码简化：
  - 删除了不必要的视频录制控制代码
  - 减少了代码复杂度
  - 提高了系统稳定性

**下一步计划：**
- 实现舵机控制功能
- 测试视频录制功能稳定性
- 优化视频质量和文件大小
- 添加视频播放功能

---

### 2026-01-28 - 修复视频录制文件大小为0KB的问题
**更新内容：**
- 修复视频录制文件大小为0KB的问题
- 在ESP32_S3_Camera_Monitor.ino中实现videoRecordTask函数
- 在setup函数中创建视频录制任务
- 添加videoRecordTask函数声明

**修改的文件：**
1. ESP32_S3_Camera_Monitor.ino - 添加videoRecordTask函数和任务创建代码

**修复的问题：**
1. 视频录制文件大小为0KB
   - 问题：startVideoRecording()只创建了AVI文件并写入了文件头，但没有任务调用writeVideoFrame()来写入视频帧
   - 修复：在ESP32_S3_Camera_Monitor.ino中实现videoRecordTask函数
   - 修复：在setup函数中调用startVideoRecording()后创建视频录制任务
   - 修复：videoRecordTask循环获取摄像头帧并调用writeVideoFrame()写入视频帧
   - 结果：视频录制正常工作，文件大小正常增长

**技术特点：**
- videoRecordTask函数：
  - 使用FreeRTOS任务进行视频录制
  - 循环获取摄像头帧（esp_camera_fb_get）
  - 调用writeVideoFrame()写入视频帧
  - 释放帧缓冲区（esp_camera_fb_return）
  - 延迟以控制帧率（1000/fps毫秒）
  - 检查isRecordingVideo()状态，停止时退出任务

- 任务创建：
  - 在setup函数中调用startVideoRecording()后创建任务
  - 使用xTaskCreate()创建任务
  - 任务名称：video_record
  - 任务堆栈：4096字节
  - 任务优先级：5
  - 传递fps参数（15）

**下一步计划：**
- 实现舵机控制功能
- 测试视频录制功能稳定性
- 优化视频质量和文件大小
- 添加视频播放功能

---

### 2026-01-28 - 修复时间同步和自动分段功能
**更新内容：**
- 修复sd_read_write.cpp缺少time.h头文件的问题
- 修复自动分段功能无法正常工作的问题
- 优化stopVideoRecording函数，支持保持录制状态
- 修复自动分段时isRecording状态管理问题

**修改的文件：**
1. sd_read_write.cpp - 添加time.h头文件，修复自动分段逻辑
2. sd_read_write.h - 修改stopVideoRecording函数签名，添加keepRecordingState参数

**修复的问题：**
1. 时间戳格式问题
   - 问题：sd_read_write.cpp缺少time.h头文件，导致NTP时间同步函数无法使用
   - 修复：添加#include "time.h"
   - 结果：时间戳格式正确显示为YYYYMMDDHHMM

2. 自动分段功能问题
   - 问题：自动分段时调用stopVideoRecording()会设置isRecording=false，导致后续录制失败
   - 修复：修改stopVideoRecording函数，添加keepRecordingState参数
   - 修复：在自动分段时传递keepRecordingState=true，保持录制状态
   - 修复：在startVideoRecording前临时设置isRecording=false
   - 结果：自动分段功能正常工作，每2分钟自动切换到新的视频文件

**技术特点：**
- stopVideoRecording函数支持两种模式：
  - stopVideoRecording(false)：完全停止录制，设置isRecording=false
  - stopVideoRecording(true)：停止当前分段但保持录制状态，isRecording保持true
- 自动分段流程：
  1. 检测到2分钟时长
  2. 调用stopVideoRecording(true)停止当前分段
  3. 临时设置isRecording=false
  4. 调用startVideoRecording()开始新的分段
  5. 重置分段开始时间
  6. 继续录制

**下一步计划：**
- 实现舵机控制功能
- 测试视频录制功能稳定性
- 优化视频质量和文件大小
- 添加视频播放功能

---

### 2026-01-28 - 优化时间戳格式和Web界面
**更新内容：**
- 修改时间戳格式为YYYYMMDDHHMM（年月日时分）
- 添加NTP时间同步功能
- 移除Web前端的视频录制控制界面
- 视频录制改为完全自动化（系统启动时自动开始）
- 优化文件命名规则，使用NTP同步的系统时间

**修改的文件：**
1. ESP32_S3_Camera_Monitor.ino - 添加NTP时间同步配置
2. sd_read_write.cpp - 修改时间戳生成函数，使用NTP时间
3. app_httpd.cpp - 更新文档说明
4. camera_index.h - 移除视频录制控制界面和相关函数

**实现的功能：**
1. NTP时间同步
   - 使用pool.ntp.org和time.nist.gov作为NTP服务器
   - 时区设置为UTC+8（北京时间）
   - 系统启动后自动同步时间
   - 串口输出当前时间

2. 时间戳文件名
   - 照片文件名格式：YYYYMMDDHHMM.jpg
   - 视频文件名格式：YYYYMMDDHHMM.avi
   - YYYY为年份（4位）
   - MM为月份（2位）
   - DD为日期（2位）
   - HH为小时（2位）
   - MM为分钟（2位）

3. Web界面优化
   - 移除视频录制控制界面（开始/停止按钮）
   - 移除录制状态指示器
   - 移除录制状态查询功能
   - 视频录制完全自动化，无需手动操作

**技术特点：**
- 使用NTP协议同步系统时间
- 时间戳格式统一，便于管理和查找
- 视频录制完全自动化，系统启动后自动开始
- Web界面简洁，只保留必要的控制功能
- 文件名示例：202601281041.jpg（2026年1月28日10:41）

**下一步计划：**
- 实现舵机控制功能
- 测试视频录制功能稳定性
- 优化视频质量和文件大小
- 添加视频播放功能

---

### 2026-01-27 - 优化视频录制功能
**更新内容：**
- 修改照片和视频文件名为时间戳格式（ESP32-xxxx.xx.xx.xx）
- 实现视频自动分段录制（2分钟一段）
- 修改为启动时自动开始录制
- 优化文件命名规则，使用系统运行时间作为时间戳

**修改的文件：**
1. sd_read_write.h - 添加时间戳文件名生成函数声明
2. sd_read_write.cpp - 实现时间戳文件名生成和自动分段功能
3. ESP32_S3_Camera_Monitor.ino - 在启动时自动开始视频录制

**实现的功能：**
1. 时间戳文件名
   - 照片文件名格式：ESP32-xxxx.xx.xx.xx.jpg
   - 视频文件名格式：ESP32-xxxx.xx.xx.xx.avi
   - xxxx为系统运行秒数
   - xx.xx.xx为时:分:秒

2. 视频自动分段
   - 每2分钟自动分段
   - 自动停止当前分段并开始新的分段
   - 分段文件名自动递增时间戳
   - 无缝衔接，不影响录制

3. 启动时自动录制
   - 系统启动时自动开始视频录制
   - 默认参数：15fps，1280x720
   - 无需手动操作

**技术特点：**
- 使用系统运行时间（millis()）作为时间戳
- 自动检测分段时长，达到2分钟自动切换
- 分段切换时自动清理旧文件（如果空间不足）
- 文件名格式统一，便于管理和查找

**下一步计划：**
- 实现舵机控制功能
- 测试视频录制功能稳定性
- 优化视频质量和文件大小
- 添加视频播放功能

---

### 2026-01-27 - 添加视频录制和自动清理功能
**更新内容：**
- 实现视频录制功能（AVI格式，MJPEG编码）
- 添加Web端视频录制控制界面
- 实现自动删除旧文件功能（55GB阈值）
- 支持自定义录制参数（帧率、分辨率）

**修改的文件：**
1. sd_read_write.h - 添加AVI文件结构体和视频录制函数声明
2. sd_read_write.cpp - 实现视频录制和自动清理功能
3. app_httpd.cpp - 添加视频录制控制接口（/record/start、/record/stop、/record/status）
4. camera_index.h - 添加视频录制界面和控制按钮

**实现的功能：**
1. 视频录制功能
   - 支持AVI格式视频录制
   - 使用MJPEG编码
   - 可自定义帧率（默认15fps）
   - 可自定义分辨率（默认1280x720）
   - 自动生成视频文件名（0.avi, 1.avi, 2.avi...）
   
2. 自动清理旧文件功能
   - SD卡空间达到55GB时自动触发
   - 优先删除videos目录中的文件
   - 如果videos目录为空，删除photos目录中的文件
   - 在开始录制前自动检查并清理空间

3. Web界面功能
   - 开始/停止录制按钮
   - 录制状态指示器（闪烁的绿色圆点）
   - 显示当前录制的视频文件名
   - 每2秒自动更新录制状态

**技术特点：**
- 使用FreeRTOS任务进行视频录制
- 支持实时状态查询
- 完善的错误处理和用户提示
- 自动空间管理，避免SD卡写满

**下一步计划：**
- 实现舵机控制功能
- 测试视频录制功能稳定性
- 优化视频质量和文件大小
- 添加视频播放功能

---

### 2026-01-27 - 添加系统运行时长显示
**更新内容：**
- 在Web前端添加系统运行时长显示功能
- 在后端添加运行时长统计功能
- 实现运行时长连续显示（本地计时，每秒更新）
- 运行时长格式：HH:MM:SS（时:分:秒）
- 在页面加载时从服务器获取初始运行时长，然后本地计时

**修改的文件：**
1. ESP32_S3_Camera_Monitor.ino - 添加运行时长统计变量和函数
2. app_httpd.cpp - 在status_handler中添加运行时长信息
3. camera_index.h - 添加运行时长显示区域和实时更新功能

**实现的功能：**
1. 系统启动时间记录
2. 运行时长计算（秒、分、时）
3. 运行时长格式化显示（HH:MM:SS）
4. Web界面实时显示运行时长
5. 页面加载时获取初始运行时长
6. 本地计时，每秒自动增加1秒
7. 每5秒更新SD卡信息（不更新运行时长）

**技术特点：**
- 使用millis()函数获取系统运行时间
- 自动计算时、分、秒
- 格式化为HH:MM:SS格式显示
- 运行时长使用本地计时，连续显示
- SD卡信息每5秒更新，运行时长每秒更新
- 完善的错误处理和用户提示

**下一步计划：**
- 实现视频录制功能
- 实现自动删除旧文件功能（当SD卡空间达到55GB时）
- 实现舵机控制功能
- 测试运行时长显示功能稳定性

---

### 2026-01-27 - Web界面摄像头设置和单位优化
**更新内容：**
- 将SD卡信息显示单位从MB改为GB（保留2位小数）
- 将摄像头默认分辨率设置为1280x720（FRAMESIZE_SVGA）
- 在Web前端添加摄像头设置界面
- 支持用户自行调节分辨率、图像质量、亮度、对比度、饱和度
- 修改后端代码支持动态调整摄像头参数
- 修复Web界面加载状态显示问题
- 移除时钟频率动态调整功能（因为需要重新初始化摄像头，会导致系统不稳定）

**修改的文件：**
1. sd_read_write.cpp - 修改SD卡空间计算函数，返回GB单位（乘以100保留2位小数）
2. app_httpd.cpp - 修改SD卡信息JSON格式，使用%.2f格式显示GB单位；移除xclk参数支持
3. camera_index.h - 添加摄像头设置界面（分辨率、图像质量、亮度、对比度、饱和度），移除时钟频率选项
4. ESP32_S3_Camera_Monitor.ino - 修改默认分辨率为FRAMESIZE_SVGA（1280x720），时钟频率改为20MHz

**实现的功能：**
1. SD卡信息以GB为单位显示（总空间、已用空间、剩余空间）
2. 摄像头默认分辨率设置为1280x720
3. Web界面摄像头设置功能：
   - 分辨率调节（QVGA、SVGA、HD、XGA、SXGA、UXGA）
   - 图像质量调节（低、中、高、极高）
   - 亮度调节（-2到+2）
   - 对比度调节（-2到+2）
   - 饱和度调节（-2到+2）
4. 动态调整摄像头参数，无需重启设备
5. 修复视频流加载状态显示问题

**技术特点：**
- SD卡空间计算使用浮点数运算，保留2位小数
- 时钟频率在启动时设置为20MHz，不支持运行时动态调整
- 使用JSON格式传输摄像头参数
- 响应式设计，设置界面布局合理
- 设置更改后自动刷新视频流
- 完善的错误处理和用户提示

**下一步计划：**
- 实现视频录制功能
- 实现自动删除旧文件功能（当SD卡空间达到55GB时）
- 实现舵机控制功能
- 测试摄像头设置功能稳定性

---

### 2026-01-27 - 优化文件目录结构和Web界面
**更新内容：**
- 优化SD卡文件目录结构，在camera目录下增加photos和videos子目录
- 在Web界面添加SD卡空间信息显示（总空间、已用空间、剩余空间）
- 添加SD卡空间查询功能（getSDFreeSpaceMB）
- 添加视频文件保存功能（saveVideoToSD）
- 添加文件列表获取功能（getFileList）
- 添加批量删除文件功能（deleteAllFiles）
- 在系统状态接口中添加SD卡空间信息

**修改的文件：**
1. sd_read_write.h - 更新目录定义（PHOTO_DIR、VIDEO_DIR），添加新函数声明
2. sd_read_write.cpp - 更新目录初始化逻辑，添加视频保存和文件管理功能
3. app_httpd.cpp - 在status_handler中添加SD卡空间信息
4. camera_index.h - 添加SD卡信息显示区域，添加自动更新功能

**实现的功能：**
1. 优化的文件目录结构（/camera/photos和/camera/videos）
2. SD卡空间实时显示（总空间、已用空间、剩余空间）
3. 自动创建photos和videos子目录
4. 视频文件保存功能（为后续视频录制做准备）
5. 文件列表获取功能
6. 批量删除文件功能
7. Web界面每5秒自动更新SD卡信息

**技术特点：**
- 分离照片和视频存储，便于管理
- 实时显示SD卡空间使用情况
- 使用JSON格式传输SD卡信息
- 响应式设计，支持多种屏幕尺寸
- 自动刷新机制，无需手动刷新页面

**下一步计划：**
- 实现视频录制功能
- 实现自动删除旧文件功能（当SD卡空间达到55GB时）
- 实现舵机控制功能
- 测试SD卡功能稳定性

---

### 2026-01-27 - 实现SD卡文件系统功能
**更新内容：**
- 创建SD卡读写模块（sd_read_write.h和sd_read_write.cpp）
- 实现SD卡初始化和检测功能
- 实现照片自动保存到SD卡功能
- 实现目录创建、文件读写等基础文件操作
- 集成SD卡功能到主程序和拍照接口

**修改的文件：**
1. sd_read_write.h - 新建SD卡操作头文件，声明SD卡相关函数
2. sd_read_write.cpp - 新建SD卡操作实现文件，实现SD卡功能
3. ESP32_S3_Camera_Monitor.ino - 集成SD卡初始化功能
4. app_httpd.cpp - 修改拍照接口，实现保存照片到SD卡

**实现的功能：**
1. SD卡初始化和检测（支持MMC、SDSC、SDHC类型）
2. SD卡容量和空间使用情况显示
3. 照片自动保存到SD卡（/camera目录）
4. 自动生成照片文件名（0.jpg, 1.jpg, 2.jpg...）
5. 目录创建、文件读写、删除等基础文件操作
6. SD卡空间查询功能

**技术特点：**
- 使用SD_MMC接口，SDIO模式，4位并行传输
- 支持FAT32/exFAT文件系统
- 自动创建照片保存目录
- 自动生成唯一文件名
- 完整的错误处理机制
- 详细的中文注释

**下一步计划：**
- 实现视频录制功能
- 实现自动删除旧文件功能（当SD卡空间达到55GB时）
- 实现舵机控制功能
- 测试SD卡功能稳定性

---

### 2026-01-27 - 功能调整与优化
**更新内容：**
- 调整项目结构，移除未实现的功能模块
- 优化HTTP服务器实现，使用ESP-IDF的httpd组件
- 简化Web界面，只保留核心功能
- 添加视频流重试机制，提高稳定性
- 添加"在新标签页中打开视频流"功能
- 修复浏览器标签页持续加载的问题

**修改的文件：**
1. app_httpd.cpp - 简化HTTP服务器实现，移除WebSocket配置
2. camera_index.h - 简化Web界面，添加视频流重试机制和新标签页功能
3. ESP32_S3_Camera_Monitor.ino - 优化摄像头配置

**实现的功能：**
1. Web端显示监控视频（MJPEG流式输出）
2. Web端控制拍照功能
3. 在新标签页中打开视频流功能
4. 基础HTTP服务器实现

**技术特点：**
- 使用Arduino框架开发
- 使用ESP-IDF的httpd组件实现HTTP服务器
- 支持OV5640摄像头，22MHz时钟
- 支持MJPEG视频流
- 支持Web界面视频显示和拍照控制
- 支持视频流重试机制

**下一步计划：**
- 测试视频流功能
- 测试拍照功能
- 测试在新标签页中打开视频流功能
- 优化系统稳定性

---

### 2026-01-26 - 项目初始化
**更新内容：**
- 创建项目文件结构
- 编写配置文件
- 实现摄像头初始化模块
- 实现WiFi连接模块
- 实现基础HTTP服务器模块
- 实现Web界面

**创建的文件：**
1. ESP32_S3_Camera_Monitor.ino - 主程序文件
2. camera_pins.h - 摄像头引脚配置文件
3. app_httpd.cpp - HTTP服务器实现文件
4. camera_index.h - Web界面HTML文件
5. partitions.csv - 分区表文件

**实现的功能：**
1. Web端显示监控视频（流式输出）
2. Web端控制拍照功能

**技术特点：**
- 使用Arduino框架开发
- 支持OV5640摄像头
- 支持MJPEG视频流

**下一步计划：**
- 优化功能性能
- 完善错误处理
- 更新文档

---
